# -*- mode:python; coding:utf-8 -*-


def create_server(name, post):
    return TestBG(
        pre      = DebPkgInstalled('libdb-java'),
        cmd      = '%s Server --Ice.Config=$testdir/server.cfg' % java_cmd,
        stdout   = name + '.out',
        save_stdout = True,
        signal   = 2,
        expected = 130,
        post     = post)

def create_client(server_out):
    return Test(
        '%s Client "$(head -1 %s)"' % (java_cmd, server_out), shell=True,
        pre = Poll(FileContains("Ready", server_out)))


classpath = str.join(':', [
        '$fulltestdir',
        '/usr/share/java/Ice.jar',
        '/usr/share/java/Freeze.jar',
        '/usr/share/java/db.jar'])

library_path = '/usr/lib/i386-linux-gnu'

java_cmd = 'java -classpath {0} -Djava.library.path={1}'.format(
    classpath, library_path)


Command('rm -rf db')
Test('mkdir db')

server0 = create_server('server0', StdOutContains('Hello (i=0): Hello, World!'))
create_client(server0.stdout)
TaskTerminator(server0, delay=1)

server1 = create_server('server1', StdOutContains('Hello (i=1): Hello, World!'))
create_client(server0.stdout)
TaskTerminator(server1, delay=1)
